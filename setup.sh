#!/bin/bash

# ============================================================================
# Script de Setup Automรกtico - Sistema SSO
# ============================================================================
# Execute este script apรณs o primeiro deploy no Easypanel
# Uso: bash setup.sh
# ============================================================================

set -e  # Para execuรงรฃo em caso de erro

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ           SETUP AUTOMรTICO - SISTEMA SSO                      โ"
echo "โ                  Easypanel Deploy                             โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Verificar se estamos no diretรณrio correto
if [ ! -f "spark" ]; then
    echo "โ Erro: Arquivo 'spark' nรฃo encontrado!"
    echo "   Execute este script a partir do diretรณrio raiz do projeto."
    exit 1
fi

# 1. Verificar conexรฃo com banco de dados
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ [1/3] Verificando conexรฃo com banco de dados..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if php spark db:table --show > /dev/null 2>&1; then
    echo "โ Conexรฃo com banco de dados OK!"
else
    echo "โ Erro: Nรฃo foi possรญvel conectar ao banco de dados!"
    echo "   Verifique as variรกveis de ambiente: DB_HOST, DB_NAME, DB_USER, DB_PASS"
    exit 1
fi

echo ""

# 2. Executar migrations
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ [2/3] Executando migrations..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

php spark migrate --all

echo "โ Migrations executadas com sucesso!"
echo ""

# 3. Executar seeders
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ [3/3] Populando banco de dados..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

php spark db:seed MasterSeeder

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                    โ SETUP CONCLUรDO!                        โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ Sistema configurado com sucesso!"
echo ""
echo "๐ Credenciais de acesso:"
echo "   โข Usuรกrio: admin"
echo "   โข Senha: DtiFB@2025"
echo ""
echo "๐ Acesse sua aplicaรงรฃo:"
echo "   โข Login: https://seu-dominio.com/sso/login"
echo "   โข Dashboard: https://seu-dominio.com/sso/admin"
echo ""
echo "โ๏ธ  IMPORTANTE: Altere a senha do admin apรณs o primeiro login!"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
